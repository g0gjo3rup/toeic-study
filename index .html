<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEIC 30å¤©å¯¦æˆ°ç‰¹è¨“ (PROç‰ˆ)</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #27ae60;
            --wrong: #e74c3c;
            --bg: #f3f4f6;
            --text: #333;
            --card-bg: #ffffff;
        }
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); padding: 20px; line-height: 1.6; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        h1 { color: var(--primary); text-align: center; border-bottom: 3px solid var(--accent); padding-bottom: 15px; margin-bottom: 25px; font-size: 1.8em; }
        
        /* é ç±¤åˆ‡æ› */
        .tabs { display: flex; background: #eee; padding: 5px; border-radius: 8px; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 12px; cursor: pointer; font-weight: bold; color: #666; border-radius: 6px; transition: 0.3s; }
        .tab.active { background: white; color: var(--primary); shadow: 0 2px 5px rgba(0,0,0,0.1); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* æ§åˆ¶å€ */
        .controls { background: #eef2f5; padding: 20px; border-radius: 10px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: space-between; align-items: center; margin-bottom: 25px; border: 1px solid #dee2e6; }
        select { padding: 10px 15px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; background: white; min-width: 200px; }
        button { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 15px; font-weight: bold; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #34495e; transform: translateY(-1px); }
        .btn-accent { background: var(--accent); color: white; }
        .btn-accent:hover { background: #219150; transform: translateY(-1px); }

        /* å–®å­—åˆ—è¡¨ */
        .word-list { list-style: none; padding: 0; }
        .word-item { padding: 20px; border-bottom: 1px solid #eee; position: relative; transition: 0.2s; border-radius: 8px; }
        .word-item:hover { background: #f8f9fa; }
        
        .word-header { display: flex; align-items: center; flex-wrap: wrap; gap: 8px; margin-bottom: 6px; }
        .index-num { color: #aaa; font-weight: bold; font-size: 0.9em; min-width: 20px; }
        .en-word { font-size: 1.5em; font-weight: 700; color: var(--primary); }
        
        .pos-tag { background: #e0e0e0; color: #555; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; font-family: monospace; }
        .ch-meaning { color: #c0392b; font-weight: bold; font-size: 1.1em; margin-left: 5px; }

        /* æ˜Ÿæ˜Ÿèˆ‡ç™¼éŸ³æ¨£å¼ */
        .stars { color: #f1c40f; font-size: 1.1em; letter-spacing: 2px; margin: 0 5px; }
        .btn-audio {
            background: white; border: 1px solid #ddd; border-radius: 50%;
            width: 26px; height: 26px; cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center;
            color: #555; margin-left: 5px; transition: 0.2s;
        }
        .btn-audio:hover { background: var(--primary); color: white; border-color: var(--primary); }

        /* æ–°å¢ï¼šåŒç¾©å­—/è¡ç”Ÿå­—å€å¡Š */
        .word-rel {
            font-size: 0.85em;
            color: #666;
            background-color: #f1f2f6;
            padding: 4px 10px;
            border-radius: 4px;
            margin-bottom: 8px;
            display: inline-block;
            border-left: 3px solid #bdc3c7;
        }
        
        .sentence-box { background: #fafafa; border: 1px dashed #ccc; padding: 10px; margin-top: 5px; font-size: 0.95em; color: #555; border-radius: 6px; }
        .en-sent { display: block; margin-bottom: 4px; font-weight: 500; color: #2c3e50; }
        
        /* æ¸¬é©—å€æ¨£å¼ */
        .quiz-card { background: #fff; padding: 25px; margin-bottom: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #eee; position: relative; overflow: hidden; }
        .quiz-tag { position: absolute; top: 0; right: 0; background: var(--primary); color: white; padding: 5px 15px; font-size: 0.8em; border-bottom-left-radius: 8px; font-weight: bold; }
        .quiz-question { font-size: 1.25em; font-weight: 600; margin-bottom: 20px; color: #2c3e50; line-height: 1.5; }
        .quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .option-btn { background: white; border: 2px solid #e0e0e0; padding: 15px; text-align: left; cursor: pointer; border-radius: 8px; transition: all 0.2s; font-size: 1em; display: flex; align-items: center; }
        .option-btn:hover { border-color: var(--accent); background: #f0fdf4; transform: translateX(5px); }
        .option-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .option-marker { display: inline-block; width: 25px; font-weight: bold; color: #999; }
        .selected .option-marker { color: white; }

        /* çµæœå€ */
        .result-stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: #f8f9fa; padding: 15px; text-align: center; border-radius: 8px; border: 1px solid #dee2e6; }
        .stat-num { font-size: 2em; font-weight: bold; color: var(--primary); }
        
        .result-item { margin-bottom: 15px; padding: 20px; border-radius: 8px; border: 1px solid #eee; background: white; }
        .result-item.correct { border-left: 6px solid var(--accent); }
        .result-item.wrong { border-left: 6px solid var(--wrong); }
        
        .answer-row { display: flex; justify-content: space-between; margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 6px; }
        .explanation { font-size: 0.95em; color: #555; margin-top: 10px; line-height: 1.6; }

        /* åŒ¯å…¥è¦–çª— */
        #importModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 999; }
        .modal-content { background: white; padding: 30px; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        textarea { width: 100%; height: 150px; margin-bottom: 15px; padding: 15px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 6px; font-family: monospace; }
        .modal-btns { text-align: right; display: flex; gap: 10px; justify-content: flex-end; }

        @media (max-width: 600px) {
            .quiz-options { grid-template-columns: 1fr; }
            .controls { flex-direction: column; align-items: stretch; }
            .result-stats { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>TOEIC 30å¤©å¯¦æˆ°ç‰¹è¨“ <span style="font-size:0.5em; background:var(--accent); color:white; padding:3px 8px; border-radius:4px; vertical-align:middle;">PRO</span></h1>
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('study')">ğŸ“– èƒŒå–®å­—</div>
        <div class="tab" onclick="switchTab('quiz')">âš”ï¸ å¯¦æˆ°æ¸¬é©—</div>
    </div>

    <div id="studySection" class="view-section active">
        <div class="controls">
            <label style="flex:1;">
                <div style="font-size:0.85em; color:#666; margin-bottom:5px;">é¸æ“‡é€²åº¦</div>
                <select id="daySelector" onchange="renderWords()" style="width:100%;"></select>
            </label>
            <button class="btn-primary" onclick="openImport()">+ åŒ¯å…¥</button>
        </div>
        <ul class="word-list" id="wordList"></ul>
    </div>

    <div id="quizSection" class="view-section">
        <div class="controls" id="quizStartScreen">
            <label style="flex:1;">
                <div style="font-size:0.85em; color:#666; margin-bottom:5px;">é¸æ“‡æ¸¬é©—ç¯„åœ</div>
                <select id="quizScopeSelector" style="width:100%;"></select>
            </label>
            <button class="btn-accent" onclick="startQuiz()">é–‹å§‹æ¸¬é©—</button>
        </div>

        <div id="quizArea" style="display:none;"></div>
        
        <div id="quizControls" style="display:none; text-align:center; margin-top:30px; padding-top:20px; border-top:1px dashed #ccc;">
            <button class="btn-accent" onclick="submitQuiz()" style="padding: 12px 50px; font-size:1.1em;">äº¤å· (Submit)</button>
        </div>

        <div id="quizResult" style="display:none;">
            <div class="result-stats">
                <div class="stat-card">
                    <div style="font-size:0.9em; color:#666;">ç¸½åˆ†</div>
                    <div class="stat-num" id="scoreBoard">0</div>
                </div>
                <div class="stat-card">
                    <div style="font-size:0.9em; color:#666;">ç­”å°é¡Œæ•¸</div>
                    <div class="stat-num" id="correctCount">0/0</div>
                </div>
            </div>
            <div id="resultList"></div>
            <div style="text-align:center; margin-top:30px;">
                <button class="btn-primary" onclick="resetQuiz()" style="width:100%;">å†ä¾†ä¸€æ¬¡</button>
            </div>
        </div>
    </div>
</div>

<div id="importModal">
    <div class="modal-content">
        <h3 style="margin-top:0;">åŒ¯å…¥ JSON è³‡æ–™</h3>
        <p style="font-size:0.9em; color:#666;">è«‹è²¼ä¸Š JSON (æ¬„ä½åŒ…å« w, m, pos, s, rel, ex, ch)ï¼š</p>
        <textarea id="importInput" placeholder='{"10": [{"w":"notice", "s":3, "rel":"[è¡] notify v. é€šçŸ¥", ...}]}'></textarea>
        <div class="modal-btns">
            <button style="background:#eee; color:#333;" onclick="closeImport()">å–æ¶ˆ</button>
            <button class="btn-accent" onclick="saveImport()">åŒ¯å…¥è³‡æ–™</button>
        </div>
    </div>
</div>

<script>
   // --- è³‡æ–™åº« (ç¶­æŒä½ çš„è³‡æ–™çµæ§‹) ---
    // w=å–®å­—, s=æ˜Ÿç´š, p=éŸ³æ¨™, pos=è©æ€§, m=å«ç¾©, rel=ç›¸é—œå­—, ex=ä¾‹å¥, ch=ä¸­è­¯
    let db = {
      "10": [
        {"w":"exactly", "s":1, "p":"/ÉªgËˆzÃ¦ktli/", "pos":"adv.", "m":"ç¢ºåˆ‡åœ°ï¼›æ­£å¥½", "rel":"[è¡] exact adj. ç¢ºåˆ‡çš„; [åŒ] precisely æº–ç¢ºåœ°", "ex":"The sales representatives help customers decide exactly what style fits them best.", "ch":"éŠ·å”®äººå“¡æœƒå¹«åŠ©é¡§å®¢æ±ºå®šç©¶ç«Ÿä»€éº¼é¢¨æ ¼æ˜¯æœ€é©åˆä»–å€‘çš„ã€‚"},
        {"w":"installment", "s":1, "p":"/ÉªnËˆstÉ”lmÉ™nt/", "pos":"n.", "m":"åˆ†æœŸä»˜æ¬¾", "rel":"", "ex":"The shop allows buyers to pay for furniture in monthly installments.", "ch":"é‚£å®¶åº—å…è¨±é¡§å®¢ç”¨æ¯æœˆåˆ†æœŸä»˜æ¬¾çš„æ–¹å¼è³¼è²·å®¶å…·ã€‚"},
        {"w":"notice", "s":3, "p":"/ËˆnoÊŠtÉªs/", "pos":"n.", "m":"é€šçŸ¥ï¼›å…¬å‘Š", "rel":"[è¡] notify v. é€šçŸ¥; notification n. é€šçŸ¥; noticeable adj. é¡¯è€Œæ˜“è¦‹çš„", "ex":"The prices listed in the catalog are effective until further notice.", "ch":"åœ¨é€²ä¸€æ­¥é€šçŸ¥ä¹‹å‰ï¼Œç›®éŒ„ä¸­åˆ—å‡ºçš„åƒ¹æ ¼éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚"},
        {"w":"charge", "s":3, "p":"/tÊƒÉ‘rdÊ’/", "pos":"n.", "m":"æ”¶è²»ï¼Œè²»ç”¨ï¼›è²¬ä»»", "rel":"[åŒ] expense è²»ç”¨", "ex":"The price includes shipping and handling charges.", "ch":"åƒ¹æ ¼åŒ…æ‹¬é‹è²»èˆ‡æ‰‹çºŒè²»ã€‚"},
        {"w":"experienced", "s":3, "p":"/ÉªkËˆspÉªriÉ™nst/", "pos":"adj.", "m":"æœ‰ç¶“é©—çš„", "rel":"[è¡] experience n. ç¶“é©—", "ex":"She is an experienced teacher.", "ch":"å¥¹æ˜¯ä¸€ä½æœ‰ç¶“é©—çš„è€å¸«ã€‚"}
      ],
      "24": [
        {"w":"designate", "s":2, "p":"/ËˆdÉ›zÉªgËŒneÉªt/", "pos":"v.", "m":"æŒ‡å®šï¼›æŒ‡æ´¾", "rel":"[è¡] designation n. æŒ‡å®š; æŒ‡æ´¾", "ex":"Ms. Carling designated Owen to be the project's team leader.", "ch":"Carling å°å§æŒ‡æ´¾äº† Owen æ“”ä»»å°ˆæ¡ˆå°çµ„çš„çµ„é•·ã€‚"},
        {"w":"executive", "s":2, "p":"/ÉªgËˆzÉ›kjÉ™tÉªv/", "pos":"adj.", "m":"ç¶“ç‡Ÿç®¡ç†çš„", "rel":"", "ex":"Mr. Fulton holds an executive position at Greenway Bank.", "ch":"Fulton å…ˆç”Ÿåœ¨ Greenway éŠ€è¡Œæ“”ä»»ç®¡ç†è·ã€‚"},
        {"w":"dedication", "s":2, "p":"/ËŒdÉ›dÉ™ËˆkeÉªÊƒÉ™n/", "pos":"n.", "m":"å°ˆå¿ƒè‡´åŠ›", "rel":"[è¡] dedicate v. è‡´åŠ›æ–¼; dedicated adj. å°ˆæ³¨çš„", "ex":"Ms. Hayes was recognized for her dedication to the company.", "ch":"Hayes å°å§å› ç‚ºå°å…¬å¸çš„å¥‰ç»è€Œå—åˆ°äº†è¡¨æšã€‚"},
        {"w":"unanimously", "s":2, "p":"/juËˆnÃ¦nÉ™mÉ™sli/", "pos":"adv.", "m":"å…¨é«”æ„è¦‹ä¸€è‡´åœ°", "rel":"", "ex":"The board voted unanimously to replace the CEO.", "ch":"è‘£äº‹æœƒæŠ•ç¥¨ä¸€è‡´æ±ºå®šè¦æ’¤æ›é‚£ä½åŸ·è¡Œé•·ã€‚"},
        {"w":"progress", "s":2, "p":"/ËˆprÉ‘grÉ›s/", "pos":"n.", "m":"å‰é€²ï¼›é€²æ­¥", "rel":"[è¡] progressive adj. é€²æ­¥çš„", "ex":"Daily reports are good tools for measuring employees' work progress.", "ch":"æ¯æ—¥å ±å‘Šæ˜¯è©•é‡å“¡å·¥å·¥ä½œé€²åº¦çš„å¥½å·¥å…·ã€‚"}
      ]
    };

    // å¯ä»¥åœ¨é€™è£¡å®šç¾©ä¸»é¡Œåç¨±ï¼Œè‹¥ç„¡å®šç¾©å‰‡é¡¯ç¤º Day X
   const themes = {
        "1": "Day 01: æ“ºè„«å¤±æ¥­ (é›‡ç”¨/é¢è©¦)",
        "2": "Day 02: å±•ç¾èƒ½åŠ› (å·¥ä½œå…§å®¹)",
        "3": "Day 03: è«‡è–ªæ°´ç¦åˆ© (è–ªè³‡/ä¼‘å‡)",
        "4": "Day 04: è¾¦å…¬å®¤äººéš› (åœ˜éšŠ/å‡é·)",
        "5": "Day 05: ç°½ç´„å…¥è· (åˆç´„/è¦å®š)",
        "6": "Day 06: æœè£è¦å®š (æœé£¾)",
        "7": "Day 07: éŠ·å”®ç­–ç•¥ (è¡ŒéŠ· 1)",
        "8": "Day 08: åœ‹éš›è¡ŒéŠ· (è¡ŒéŠ· 2)",
        "9": "Day 09: æŒ½æ•‘ç¶“æ¿Ÿ (ç¶“æ¿Ÿ)",
        "10": "Day 10: è³¼ç‰©é«˜æ‰‹ (è³¼ç‰©)",
        "11": "Day 11: æ–°ç”¢å“ä¸Šå¸‚ (ç”¢å“é–‹ç™¼)",
        "12": "Day 12: å·¥å» è‡ªå‹•åŒ– (ç”Ÿç”¢)",
        "13": "Day 13: é¡§å®¢è‡³ä¸Š (é¡§å®¢æœå‹™)",
        "14": "Day 14: å‡ºå·®çš„ç›®çš„ (æ—…éŠ/æ©Ÿå ´)",
        "15": "Day 15: è²¿æ˜“å”å®š (å•†æ¥­)",
        "16": "Day 16: é™æ™‚é…é€ (è²¿æ˜“/è²¨é‹)",
        "17": "Day 17: ç‰¹åˆ¥æ–™ç† (ä½å®¿/é¤å»³)",
        "18": "Day 18: ç¯€çœç¶“è²» (æœƒè¨ˆ)",
        "19": "Day 19: è¾¦å…¬å®¤æ°£æ°› (å…¬å¸å‹•å‘)",
        "20": "Day 20: ç·Šæ€¥æœƒè­° (æœƒè­°)",
        "21": "Day 21: é–‹è»Š (äº¤é€š)",
        "22": "Day 22: å­˜æ¬¾èˆ‡ç›¡å­ (éŠ€è¡Œ)",
        "23": "Day 23: å‹æƒ…èˆ‡æŠ•è³‡ (æŠ•è³‡)",
        "24": "Day 24: å¤å…¸é¢¨å‘³ (å»ºç¯‰/ä½å®…)",
        "25": "Day 25: å¤©æ°£é å ± (ç’°å¢ƒ)",
        "26": "Day 26: é‡å¤§ç–¾ç—… (å¥åº·)",
        "27": "Day 27: ç¤¾äº¤æ´»å‹• (å¨›æ¨‚/æ–‡åŒ–)",
        "28": "Day 28: ç§‘æŠ€è¶¨å‹¢ (é›»è…¦/ç¶²è·¯)",
        "29": "Day 29: æ³•å¾‹äº‹å‹™ (æ³•å¾‹)",
        "30": "Day 30: å…¬å…±å»ºè¨­ (ç¤¾æœƒ/æ”¿åºœ)"
    };

    const daySelector = document.getElementById('daySelector');
    const wordList = document.getElementById('wordList');
    const quizScopeSelector = document.getElementById('quizScopeSelector');
    const importModal = document.getElementById('importModal');
    const importInput = document.getElementById('importInput');

    let currentQuizQuestions = [];
    let userAnswers = {};

    function init() {
        // å˜—è©¦è®€å–èˆŠè³‡æ–™ (ç›¸å®¹ V2/V3)
        const savedData = localStorage.getItem('toeicProV3') || localStorage.getItem('toeicProV2');
        if (savedData) {
            try { db = { ...db, ...JSON.parse(savedData) }; } catch(e){}
        }
        updateMenus();
        
        // é è¨­é¸æ“‡ç¬¬ä¸€ç­†è³‡æ–™
        const firstDay = Object.keys(db).sort((a,b)=>Number(a)-Number(b))[0];
        if(firstDay) daySelector.value = firstDay;
        renderWords();
    }

    // â˜… ä¿®æ”¹é»ï¼šå„ªåŒ–é¸å–®é‚è¼¯ (å–®æ—¥ / 5æ—¥ / å…¨éƒ¨)
    function updateMenus() {
        // 1. æ›´æ–°èƒŒå–®å­—é¸å–® (ç¶­æŒå–®æ—¥é¸æ“‡)
        daySelector.innerHTML = "";
        const days = Object.keys(db).map(Number).sort((a,b)=>a-b);
        
        days.forEach(i => {
            let label = themes[i] || `Day ${i}`;
            daySelector.add(new Option(label, i));
        });

        // 2. æ›´æ–°æ¸¬é©—é¸å–® (åˆ†çµ„é¡¯ç¤º)
        quizScopeSelector.innerHTML = "";

        // Group A: å–®æ—¥æ¸¬é©—
        const groupSingle = document.createElement('optgroup');
        groupSingle.label = "ğŸ“‹ å–®æ—¥æ¸¬é©— (One Day)";
        days.forEach(d => {
            let label = themes[d] ? themes[d].split(":")[0] : `Day ${d}`;
            groupSingle.appendChild(new Option(label, d));
        });
        quizScopeSelector.add(groupSingle);

        // Group B: 5å¤©å€é–“æ¸¬é©— (1-5, 6-10...)
        const groupRange = document.createElement('optgroup');
        groupRange.label = "ğŸ“… éšæ®µè¤‡ç¿’ (5 Days)";
        
        // æƒæ 1~30 å¤© (å‡è¨­TOEICæ›¸é€šå¸¸30å¤©)
        for (let start = 1; start <= 30; start += 5) {
            let end = start + 4;
            // æª¢æŸ¥é€™å€é–“å…§æœ‰æ²’æœ‰ä»»ä½•åŒ¯å…¥çš„è³‡æ–™
            let hasData = days.some(d => d >= start && d <= end);
            
            if (hasData) {
                // é¡¯ç¤ºæ¨™ç±¤ï¼Œä¾‹å¦‚ "Day 1 - 5", "Day 6 - 10"
                groupRange.appendChild(new Option(`Day ${start} - ${end}`, `${start}-${end}`));
            }
        }
        // å¦‚æœæœ‰ç”¢ç”Ÿå€é–“é¸é …ï¼Œæ‰åŠ å…¥é€™å€‹ç¾¤çµ„
        if (groupRange.children.length > 0) {
            quizScopeSelector.add(groupRange);
        }

        // Group C: ç¸½è¤‡ç¿’
        const groupAll = document.createElement('optgroup');
        groupAll.label = "ğŸ† çµ‚æ¥µæŒ‘æˆ°";
        groupAll.appendChild(new Option("å…¨ç¯„åœç¸½è¤‡ç¿’ (All)", "all"));
        quizScopeSelector.add(groupAll);
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        
        if (tab === 'study') {
            document.querySelector('.tab:nth-child(1)').classList.add('active');
            document.getElementById('studySection').classList.add('active');
        } else {
            document.querySelector('.tab:nth-child(2)').classList.add('active');
            document.getElementById('quizSection').classList.add('active');
        }
    }

    function playAudio(text) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 0.8;
        window.speechSynthesis.speak(utterance);
    }

    function getStars(level) {
        if (!level) return '<span class="stars">â˜…â˜…â˜…</span>';
        let starStr = level >= 3 ? "â˜…â˜…â˜…" : (level === 2 ? "â˜…â˜…" : "â˜…");
        return `<span class="stars">${starStr}</span>`;
    }

    function renderWords() {
        const day = daySelector.value;
        wordList.innerHTML = "";
        
        if (!db[day]) {
            wordList.innerHTML = `<li style="padding:20px; text-align:center; color:#999;">æœ¬æ—¥å°šç„¡å–®å­—è³‡æ–™ã€‚</li>`;
            return;
        }

        db[day].forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'word-item';
            
            let relHtml = item.rel ? `<div class="word-rel">${item.rel}</div>` : "";

            li.innerHTML = `
                <div class="word-header">
                    <span class="index-num">${index+1}.</span>
                    <span class="en-word">${item.w}</span>
                    <button class="btn-audio" onclick="playAudio('${item.w}')">ğŸ”Š</button>
                    <span class="pos-tag">${item.pos}</span>
                    ${getStars(item.s)}
                    <span class="ch-meaning">${item.m}</span>
                </div>
                ${relHtml}
                <div class="sentence-box">
                    <span class="en-sent">${item.ex}</span>
                    <span style="font-size:0.9em; color:#888;">${item.ch}</span>
                </div>
            `;
            wordList.appendChild(li);
        });
    }

    // --- â˜… ä¿®æ”¹é»ï¼šæ¸¬é©—ç¯„åœé‚è¼¯ ---
    function startQuiz() {
        const scope = quizScopeSelector.value;
        let pool = [];

        // 1. è™•ç† "All"
        if (scope === 'all') {
            Object.values(db).forEach(d => pool = pool.concat(d));
        } 
        // 2. è™•ç† "ç¯„åœ" (ä¾‹å¦‚ "1-5", "6-10")
        else if (scope.includes("-")) {
            const [start, end] = scope.split("-").map(Number);
            // æŠŠç¯„åœå…§æ¯ä¸€å¤©çš„å–®å­—éƒ½åŠ é€²ä¾†
            for (let i = start; i <= end; i++) {
                if (db[i]) {
                    pool = pool.concat(db[i]);
                }
            }
        } 
        // 3. è™•ç† "å–®æ—¥"
        else {
            if (db[scope]) pool = db[scope];
        }

        if (pool.length < 4) {
            alert("æ‰€é¸ç¯„åœå–®å­—é‡å¤ªå°‘ (è‡³å°‘éœ€4å€‹)ï¼Œè«‹é¸æ“‡å…¶ä»–ç¯„åœæˆ–åŒ¯å…¥æ›´å¤šå–®å­—ã€‚");
            return;
        }

        // é¡Œç›®æ•¸é‡ï¼šæœ€å¤šå‡º 15 é¡Œ (é¿å…ä¸€æ¬¡åšå¤ªä¹…)
        const questionCount = Math.min(pool.length, 15);
        const selectedWords = shuffle(pool).slice(0, questionCount);
        
        currentQuizQuestions = selectedWords.map(word => generateSmartQuestion(word, pool));
        userAnswers = {};

        // UI åˆ‡æ›
        document.getElementById('quizStartScreen').style.display = 'none';
        document.getElementById('quizArea').style.display = 'block';
        document.getElementById('quizControls').style.display = 'block';
        document.getElementById('quizResult').style.display = 'none';

        renderQuizQuestions();
        window.scrollTo(0,0);
    }

    function generateSmartQuestion(target, fullPool) {
        const mode = Math.random() > 0.4 ? 'sentence' : 'meaning';
        const targetPos = target.pos.split('.')[0].trim().toLowerCase(); 
        
        // æ‰¾åŒè©æ€§çš„å¹²æ“¾é …
        let samePosWords = fullPool.filter(w => w.w !== target.w && w.pos.toLowerCase().includes(targetPos));
        let distractors = [];

        if (samePosWords.length >= 3) {
            distractors = shuffle(samePosWords).slice(0, 3);
        } else {
            let otherWords = fullPool.filter(w => w.w !== target.w);
            distractors = shuffle(otherWords).slice(0, 3);
        }

        let questionText = "";
        let displayOptions = shuffle([target.w, ...distractors.map(d => d.w)]);

        if (mode === 'sentence') {
            // ç”¨åº•ç·šå–ä»£å–®å­—åŠå…¶è®ŠåŒ–å½¢
            const regex = new RegExp(target.w + "(ing|ed|s|d|es|ly)?", "gi");
            questionText = target.ex.replace(regex, "_______");
        } else {
            questionText = `ä¸‹åˆ—å“ªå€‹å–®å­—çš„æ„æ€æ˜¯ï¼š<br><span style="color:#c0392b; font-size:1.3em;">ã€Œ${target.m}ã€</span>ï¼Ÿ`;
        }

        return {
            mode: mode,
            q: questionText,
            correct: target.w,
            options: displayOptions,
            data: target
        };
    }

    function renderQuizQuestions() {
        const area = document.getElementById('quizArea');
        area.innerHTML = "";
        const markers = ['A', 'B', 'C', 'D'];

        currentQuizQuestions.forEach((q, index) => {
            const div = document.createElement('div');
            div.className = 'quiz-card';
            const tagLabel = q.mode === 'sentence' ? 'æ–‡æ³•èˆ‡èªå¢ƒ' : 'å–®å­—é‡‹ç¾©';

            div.innerHTML = `
                <div class="quiz-tag">${tagLabel}</div>
                <div class="quiz-question">${index+1}. ${q.q}</div>
                <div class="quiz-options">
                    ${q.options.map((opt, i) => `
                        <div class="option-btn" onclick="selectOption(${index}, '${opt}', this)">
                            <span class="option-marker">${markers[i]}.</span> ${opt}
                        </div>
                    `).join('')}
                </div>
            `;
            area.appendChild(div);
        });
    }

    function selectOption(qIndex, answer, element) {
        userAnswers[qIndex] = answer;
        const parent = element.parentElement;
        parent.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        element.classList.add('selected');
    }

    function submitQuiz() {
        if (Object.keys(userAnswers).length < currentQuizQuestions.length) {
            if(!confirm("é‚„æœ‰é¡Œç›®æ²’å¯«å®Œï¼Œç¢ºå®šè¦äº¤å·å—ï¼Ÿ")) return;
        }

        let score = 0;
        let html = "";

        currentQuizQuestions.forEach((q, index) => {
            const userAns = userAnswers[index];
            const isCorrect = (userAns === q.correct);
            if(isCorrect) score++;

            html += `
                <div class="result-item ${isCorrect ? 'correct' : 'wrong'}">
                    <div style="font-weight:bold; margin-bottom:5px;">Q${index+1}</div>
                    <div style="margin-bottom:10px;">${q.q}</div>
                    
                    <div class="answer-row">
                        <span>ä½ çš„é¸æ“‡: <b style="color:${isCorrect?'green':'red'}">${userAns || "æœªä½œç­”"}</b></span>
                        ${!isCorrect ? `<span>æ­£è§£: <b style="color:green">${q.correct}</b></span>` : ''}
                    </div>

                    <div class="explanation">
                        <strong>ğŸ’¡ å–®å­—è§£æï¼š</strong>
                        <span style="color:#2980b9; font-weight:bold;">${q.data.w}</span> 
                        <span style="background:#eee; padding:0 4px; font-size:0.8em;">${q.data.pos}</span> 
                        ${getStars(q.data.s)}
                        ${q.data.m}<br>
                        ${q.data.rel ? `<span style="font-size:0.9em; color:#666; background:#f1f2f6; padding:2px 5px; border-radius:3px;">${q.data.rel}</span><br>` : ''}
                        <em>ä¾‹å¥ï¼š${q.data.ex}</em>
                    </div>
                </div>
            `;
        });

        const finalScore = Math.round((score / currentQuizQuestions.length) * 100);
        document.getElementById('scoreBoard').innerText = finalScore;
        document.getElementById('correctCount').innerText = `${score} / ${currentQuizQuestions.length}`;
        document.getElementById('resultList').innerHTML = html;

        document.getElementById('quizArea').style.display = 'none';
        document.getElementById('quizControls').style.display = 'none';
        document.getElementById('quizResult').style.display = 'block';
        window.scrollTo(0,0);
    }

    function resetQuiz() {
        document.getElementById('quizStartScreen').style.display = 'flex';
        document.getElementById('quizResult').style.display = 'none';
    }

    function shuffle(array) {
        let currentIndex = array.length, randomIndex;
        const newArr = [...array];
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [newArr[currentIndex], newArr[randomIndex]] = [newArr[randomIndex], newArr[currentIndex]];
        }
        return newArr;
    }

    function openImport() { importModal.style.display = "flex"; importInput.value = ""; }
    function closeImport() { importModal.style.display = "none"; }
    function saveImport() {
        try {
            const raw = importInput.value;
            if (!raw.trim()) return;
            const newData = JSON.parse(raw);
            db = { ...db, ...newData };
            localStorage.setItem('toeicProV3', JSON.stringify(db));
            alert("åŒ¯å…¥æˆåŠŸï¼");
            updateMenus();
            closeImport();
        } catch (e) { alert("JSON æ ¼å¼éŒ¯èª¤"); }
    }

    // å•Ÿå‹•åˆå§‹åŒ–
    init();
</script>

</body>
</html>